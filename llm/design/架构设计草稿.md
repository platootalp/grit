# LLM 应用构建平台 DDD 架构设计文档

## 1. 领域探索（Domain Exploration）

### 目标：
明确平台的核心业务领域、关键需求和边界，为后续的子域划分和限界上下文定义提供基础。

### 过程：
- 与用户及利益相关者进行深入沟通，了解平台功能需求和使用场景。
- 基于背景信息中提到的功能点（如智能体创建、RAG、API接口、流程编排等），识别出核心业务逻辑。
- 从领域驱动设计的角度出发，将整个系统划分为多个具有清晰职责的业务领域，并定义它们之间的依赖关系。
- 确保对业务术语、规则、约束的理解一致。

### 产出物：

| 领域名称         | 描述                                           | 关键业务能力                         |
|----------------|----------------------------------------------|------------------------------------|
| 智能体管理       | 用户可以创建、配置、发布和管理“智能体”              | 创建智能体、配置角色、提示词、插件     |
| 流程编排         | 提供可视化工具用于构建应用流程                       | 节点式流程图、流程执行引擎              |
| RAG知识库        | 支持基于知识库的增强能力                             | 知识库管理、检索服务                   |
| API网关         | 提供统一的API接口供第三方调用                        | API注册、鉴权、监控                    |
| 多租户与权限      | 实现多租户隔离和权限控制                           | 租户管理、权限模型                    |
| 审计日志         | 记录系统操作日志                                  | 日志记录、查询、分析                   |
| 模型集成         | 兼容多种大模型服务商                               | 模型配置、服务调用适配                 |

---

## 2. 子域识别（Subdomain Identification） - 重新设计

### 目标：
将整体业务领域进一步细分为多个子域，明确每个子域的职责边界，并区分核心子域、支撑子域和通用子域。

### 过程：
- 根据领域探索的结果，将每个领域拆解为更小的业务单元，形成子域。
- 区分哪些子域是核心业务（如智能体管理、流程编排），哪些是支撑性功能（如审计日志、权限管理）。
- 对每个子域进行优先级排序，确保开发资源合理分配。

### 产出物：

| 子域名称       | 所属领域          | 类型   | 职责描述                              |
|--------------|-----------------|------|-------------------------------------|
| 智能体配置     | 智能体管理         | 核心子域 | 管理智能体的基本属性（角色、提示词、插件等） |
| 流程节点定义   | 流程编排           | 核心子域 | 支持用户在流程图中添加和配置节点             |
| 智能体部署     | 智能体管理         | 核心子域 | 将配置好的智能体发布到运行环境               |
| RAG知识库管理  | RAG知识库          | 支撑子域 | 管理知识库内容和索引                       |
| API服务注册    | API网关           | 支撑子域 | 注册和管理API服务                         |
| 多租户管理     | 多租户与权限        | 支撑子域 | 管理租户和权限体系                        |
| 权限控制       | 多租户与权限        | 支撑子域 | 控制用户访问不同资源的权限                   |
| 审计日志记录    | 审计日志           | 通用子域 | 记录用户的操作行为                        |
| 模型服务接入    | 模型集成           | 支撑子域 | 集成并调用不同的大模型服务商                |

---

## 3. 上下文映射（Context Mapping） 

### 目标：
明确各个子域之间的关系，定义限界上下文边界，避免跨上下文的耦合问题。

### 过程：
- 根据子域的职责和依赖关系，将它们划分为独立的限界上下文。
- 定义限界上下文之间的交互方式（如共享内核、防腐层、开放主机等）。
- 明确各限界上下文的数据一致性策略（如事件驱动、同步通信等）。

### 产出物：

| 限界上下文名称       | 所属子域                | 交互类型   | 说明                                   |
|--------------------|-----------------------|--------|--------------------------------------|
| 智能体管理上下文     | 智能体配置、智能体部署       | 限界上下文  | 独立负责智能体生命周期管理                  |
| 流程编排上下文       | 流程节点定义              | 限界上下文  | 负责流程图的设计和执行                     |
| RAG知识库上下文      | RAG知识库管理             | 限界上下文  | 负责知识库的存储和检索                     |
| API网关上下文       | API服务注册              | 限界上下文  | 提供统一的API入口                        |
| 多租户与权限上下文    | 多租户管理、权限控制        | 限界上下文  | 管理租户和用户权限                        |
| 审计日志上下文       | 审计日志记录              | 限界上下文  | 记录系统操作日志                         |
| 模型集成上下文       | 模型服务接入              | 限界上下文  | 集成和调用大模型服务                      |

### 上下文映射关系示例：
- **智能体管理上下文** 和 **流程编排上下文** 之间通过 **开放主机模式** 进行通信，智能体管理提供智能体配置信息，流程编排根据该信息生成流程图。
- **流程编排上下文** 和 **模型集成上下文** 之间通过 **事件驱动** 模式通信，当流程中涉及模型调用时，会触发 `model-call-event` 事件。
- **模型集成上下文** 和 **智能体管理上下文** 之间通过 **防腐层** 进行通信，以处理不同模型服务的格式差异。
- **多租户与权限上下文** 和其他上下文之间通过 **共享内核** 模式进行通信，例如共享租户ID、用户权限等信息。
- **审计日志上下文** 与所有其他上下文之间通过 **事件驱动** 模式进行通信，记录系统操作行为。

---

## 4. 领域建模（Domain Modeling）

### 目标

基于限界上下文的划分，定义核心对象及其关系，构建领域模型。包括聚合根、实体、值对象和领域服务。

### 过程

* 对每个限界上下文进行细化分析，识别关键业务对象。
* 定义这些对象之间的关系，并确定哪些对象作为聚合根。
* 明确值对象和实体的职责边界。
* 确定领域服务，用于封装跨聚合的操作逻辑。

---

### 智能体管理上下文

#### 聚合根/实体

| 名称     | 描述                    | 属性                                                |
| ------ | --------------------- | ------------------------------------------------- |
| Agent  | 智能体的核心实体，代表一个可运行的应用实例 | id, name, role, prompt, plugins, status, tenantId |
| Plugin | 插件能力，用于扩展智能体功能        | id, name, description, config                     |
| Prompt | 提示词模板，用于定义智能体行为       | id, content, version                              |

#### 值对象

| 名称            | 描述       | 属性                                  |
| ------------- | -------- | ----------------------------------- |
| PluginConfig  | 插件的配置信息  | type, parameters                    |
| PromptVersion | 提示词的版本信息 | versionNumber, createdAt, updatedAt |

#### 领域服务

* `AgentService`：提供智能体创建、更新、部署等操作的业务逻辑

---

### 流程编排上下文

#### 聚合根/实体

| 名称       | 描述                 | 属性                                   |
| -------- | ------------------ | ------------------------------------ |
| Workflow | 流程图的抽象，由多个节点组成     | id, name, nodes, tenantId            |
| Node     | 流程中的一个节点，表示某种操作或条件 | id, type, configuration, nextNodeIds |

#### 值对象

| 名称                | 描述        | 属性                      |
| ----------------- | --------- | ----------------------- |
| NodeConfiguration | 节点的具体配置信息 | type, params, condition |

#### 领域服务

* `WorkflowService`：提供流程图的设计、执行、保存等操作的业务逻辑

---

### RAG 知识库上下文

#### 聚合根/实体

| 名称            | 描述           | 属性                                     |
| ------------- | ------------ | -------------------------------------- |
| KnowledgeBase | 知识库实体，包含多个文档 | id, name, documents, tenantId          |
| Document      | 文档实体，存储具体内容  | id, content, metadata, vectorEmbedding |

#### 值对象

| 名称       | 描述     | 属性                               |
| -------- | ------ | -------------------------------- |
| Metadata | 文档的元数据 | title, source, author, timestamp |

#### 领域服务

* `KnowledgeBaseService`：提供知识库管理、文档上传、检索等操作的业务逻辑

---

### API 网关上下文

#### 聚合根/实体

| 名称         | 描述            | 属性                                             |
| ---------- | ------------- | ---------------------------------------------- |
| APIService | API 服务，供第三方调用 | id, name, endpoint, method, authType, tenantId |
| APIKey     | 访问 API 的密钥    | id, apiKey, secretKey, expiresAt, scope        |

#### 值对象

| 名称       | 描述        | 属性                       |
| -------- | --------- | ------------------------ |
| AuthType | API 的鉴权方式 | type (如 OAuth2, API Key) |

#### 领域服务

* `APIService`：提供 API 注册、鉴权、监控等操作的业务逻辑

---

### 多租户与权限上下文

#### 聚合根/实体

| 名称     | 描述             | 属性                                  |
| ------ | -------------- | ----------------------------------- |
| Tenant | 租户实体，表示不同的企业用户 | id, name, plan, status              |
| User   | 用户实体，属于某个租户    | id, username, email, tenantId, role |
| Role   | 角色实体，定义用户权限    | id, name, permissions               |

#### 值对象

| 名称         | 描述            | 属性                          |
| ---------- | ------------- | --------------------------- |
| Permission | 权限实体，定义资源访问规则 | resource, action, condition |

#### 领域服务

* `TenantService`：提供租户管理、用户权限控制等操作的业务逻辑

---

### 审计日志上下文

#### 聚合根/实体

| 名称       | 描述     | 属性                                     |
| -------- | ------ | -------------------------------------- |
| AuditLog | 审计日志记录 | id, userId, action, timestamp, details |

#### 值对象

| 名称            | 描述      | 属性                            |
| ------------- | ------- | ----------------------------- |
| ActionDetails | 操作的详细信息 | operation, resourceId, result |

#### 领域服务

* `AuditLogService`：提供日志记录、查询等操作的业务逻辑

---

### 模型集成上下文

#### 聚合根/实体

| 名称            | 描述      | 属性                                    |
| ------------- | ------- | ------------------------------------- |
| ModelProvider | 大模型服务商  | id, name, endpoint, apiKey, secretKey |
| ModelConfig   | 模型的配置信息 | id, providerId, modelType, parameters |

#### 值对象

| 名称              | 描述      | 属性                           |
| --------------- | ------- | ---------------------------- |
| ModelParameters | 模型的参数配置 | temperature, maxTokens, topP |

#### 领域服务

* `ModelIntegrationService`：提供模型服务商接入、配置、调用等操作的业务逻辑

---

## 5. 应用服务编排

### 目标

将各限界上下文的领域模型通过应用服务进行整合，形成完整的业务流程。

### 过程

* 根据业务场景设计应用服务，将不同限界上下文的领域模型组合在一起。
* 明确应用服务的输入输出，确保服务之间的松耦合。
* 设计事务边界和异常处理机制，保证系统可靠性。

### 产出物

| 应用服务名称             | 功能描述         | 调用的限界上下文        | 输入                                 | 输出              |
| ------------------ | ------------ | --------------- | ---------------------------------- | --------------- |
| CreateAgentApp     | 创建并发布一个智能体应用 | 智能体管理、流程编排、模型集成 | agentConfig, workflow, modelConfig | deployedAgentId |
| UpdateAgentApp     | 更新已发布的智能体应用  | 智能体管理、流程编排      | agentId, updatedConfig             | success/failure |
| RunAgentApp        | 运行智能体应用      | 智能体管理、流程编排、模型集成 | agentId, input                     | response        |
| RegisterAPIService | 注册 API 接口    | API 网关          | apiConfig                          | serviceId       |
| GetAuditLogs       | 查询审计日志       | 审计日志            | queryConditions                    | auditLogs       |
| AddTenant          | 添加新租户        | 多租户与权限          | tenantInfo                         | tenantId        |
| AssignUserToRole   | 分配用户角色       | 多租户与权限          | userId, roleId                     | success/failure |

---

## 6. 基础设施设计（适配器、网关、数据库、模型服务集成）

### 目标

为领域模型提供基础设施支持，包括数据库、消息队列、缓存、模型服务调用等。

### 数据库设计

#### 关系型数据库（MySQL）

* **agents 表**：存储智能体信息（id, name, role, prompt, status, tenant\_id）
* **plugins 表**：存储插件信息（id, name, description, config）
* **workflows 表**：存储流程图信息（id, name, tenant\_id）
* **nodes 表**：存储流程节点信息（id, workflow\_id, type, configuration）
* **knowledge\_bases 表**：存储知识库信息（id, name, tenant\_id）
* **documents 表**：存储文档信息（id, content, metadata, kb\_id）
* **apis 表**：存储 API 服务信息（id, name, endpoint, method, auth\_type, tenant\_id）
* **tenants 表**：存储租户信息（id, name, plan, status）
* **users 表**：存储用户信息（id, username, email, tenant\_id, role\_id）
* **roles 表**：存储角色信息（id, name, permissions）
* **audit\_logs 表**：存储审计日志信息（id, user\_id, action, timestamp, details）

#### 非关系型数据库（MongoDB）

* 存储文档的向量化表示（如 `vector_embeddings` 集合）
* 存储流程执行时的临时状态（如 `workflow_executions` 集合）

### 消息队列设计

* 使用 Kafka 或 RabbitMQ 实现异步任务处理（如流程执行、日志记录、模型调用）
* 消息类型包括：

    * `agent-deployed`
    * `workflow-executed`
    * `log-recorded`
    * `model-response`

### 缓存设计

* 使用 Redis 缓存高频访问的数据（如租户信息、用户角色、API 接口配置）
* 设置合理的过期时间，避免缓存污染

### 模型服务适配器

```java
public interface ModelServiceAdapter {
    String callModel(String prompt, Map<String, Object> parameters);
}
```

每种大模型服务商（如 OpenAI、阿里云、讯飞）设计独立适配器，适配通用请求格式到各自 API。

### API 网关设计

* 使用 Spring Cloud Gateway 或 Nginx 作为统一 API 网关
* 功能：

    * **请求路由**：按路径或标识转发
    * **鉴权**：API Key/Token 验证
    * **路由策略**：负载均衡、熔断、流控

---

## 7. 上下文之间的通信机制与防腐层设计

### 目标

确保限界上下文之间能够高效通信，同时保持低耦合，防止外部变化对内部系统造成影响。

### 通信机制设计

#### 同步通信（RESTful API）

适用于实时响应场景，如智能体部署、API 接口调用

> 示例：`/api/v1/agents/{id}/deploy`

#### 异步通信（消息队列）

适用于高并发、长耗时任务，如流程执行、模型调用、日志记录

> 示例：`workflow-executed` 事件通知审计日志模块

#### 共享内核（Shared Kernel）

共享通用模型（如 `WorkflowExecutionResult`），要求变更受控

#### 防腐层（Anti-Corruption Layer）

用于转换格式或隔离业务差异

```java
public class ModelAdaptor {
    public String adaptPrompt(String originalPrompt, String modelProvider) {
        // 根据模型服务商对提示词进行适配
        return adaptedPrompt;
    }
}
```

---

### 上下文间通信示例

* **智能体管理 → 流程编排**

    * 通信方式：REST API
    * 内容：传递智能体配置信息用于流程图生成

* **流程编排 → 模型集成**

    * 通信方式：事件驱动
    * 内容：触发模型调用事件 `model-call-event`

* **模型集成 → 智能体管理**

    * 通信方式：同步通信 + 防腐层
    * 内容：返回模型调用结果，适配处理后更新状态

---

## 总结

本设计以 **领域驱动设计（DDD）** 为核心，围绕企业的 LLM 应用构建平台，从：

* 领域建模
* 子域划分
* 应用服务编排
* 基础设施设计
* 上下文通信机制与防腐层

逐步构建高内聚、松耦合、可扩展的架构，满足多租户、权限控制、模型兼容性等关键需求，具备良好的稳定性与可维护性，助力业务快速演进。

---
