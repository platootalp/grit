## ✅ **上下文视角重组：平台三层架构（核心 / 支撑 / 通用）**

按照 DDD 推荐的 **层次模型**，可以抽象成以下结构：

```text
┌────────────────────┐
│       ⚙ 通用域（Generic）      │ ← 工程能力 & 基础设施
└────────▲───────────┘
         │依赖
┌────────┴───────────┐
│       🧱 支撑域（Supporting）   │ ← 上下文补全 & 运营保障
└────────▲───────────┘
         │依赖
┌────────┴───────────┐
│       🧠 核心域（Core）        │ ← 核心业务流程 & 竞争优势
└────────────────────┘
```

---

## 🔁 **上下文内的职责重构与边界建议**

### 🧠 核心域（智能体业务核心流程的所有者）

| 限界上下文                | 核心职责                        | 外部依赖             |
| -------------------- | --------------------------- | ---------------- |
| 多模型接入与模型路由           | 模型适配、负载均衡、fallback 调度       | Plugin, MCP, API |
| Prompt 模块            | Prompt 模板系统、变量绑定、上下文插值      | 文件存储, RAG        |
| RAG 管理               | 文档嵌入、检索器管理、知识接口封装           | 文件存储, 向量库        |
| 智能体构建与运行             | Agent 生命周期、状态、配置、动态加载执行流    | 工作流引擎, 插件平台      |
| 工作流引擎                | 节点编排、条件/循环/异步逻辑、执行追踪        | 插件调用, 定时任务       |
| 插件平台（含 Tool-Calling） | 注册/调用第三方功能模块（搜索、数据库、外部 API） | 外部服务, 网关         |
| 应用市场                 | 智能体分享、导入导出、模板复用、推荐算法        | 用户系统, 智能体配置      |
| 渠道集成与部署              | Slack、Web、小程序、钉钉、API 的渠道适配  | 网关, Auth         |

📌 **说明：**

> 这些上下文应是你建模聚焦的“核心聚合根（Aggregate Root）”，具备行为/实体/规则，优先设计领域服务与工厂。

---

### 🧱 支撑域（为核心域提供业务上下文与运营服务）

| 限界上下文   | 核心职责                          | 耦合方向      |
| ------- | ----------------------------- | --------- |
| 用户与权限系统 | 用户、角色、组织架构、细粒度权限控制            | 通用域（认证）   |
| 操作审计    | 工作流执行记录、用户行为轨迹、敏感操作留痕         | 核心域       |
| 消息与通知   | 工作流结束通知、系统状态变更提醒、Webhook      | 工作流引擎     |
| 数据统计与监控 | 平台运行指标（QPS、使用量、成功率）与智能体分析面板展示 | 智能体、模型路由器 |
| 对话历史管理  | 多轮上下文存储、查询、归档支持               | 智能体、渠道集成  |
| 支付与计费   | 用户订阅管理、调用计费、账单出具              | 核心调用次数统计  |

📌 **说明：**

> 支撑域可以做一定的数据服务抽象，例如历史记录服务、审计服务，便于跨模块共享。通常通过 API 提供给核心域调用。

---

### ⚙ 通用域（基础通用组件）

| 限界上下文    | 核心职责                       | 面向服务方向          |
| -------- | -------------------------- | --------------- |
| 身份认证     | 登录、注册、Token、Session 管理     | 面向用户系统          |
| API 网关   | 接口统一路由、限流、鉴权、安全            | 面向所有服务          |
| 文件与对象存储  | Prompt 模板、知识文档、Agent 配置持久化 | 面向 Prompt、RAG 等 |
| 国际化与本地化  | UI/提示语国际化资源包、区域格式支持        | 面向前端层           |
| 定时任务与触发器 | cron/job/event 自动触发流程      | 面向工作流引擎         |

📌 **说明：**

> 通用域多数可以抽象为平台级公共服务，也适合作为中台或基础设施层服务独立部署。

---

## 🧭 限界上下文建议图（文字简图）

```text
                ┌────────────┐
                │    通用域     │
                │（身份、存储、网关）│
                └────┬───────┘
                     │
           ┌─────────▼──────────┐
           │      支撑域（平台能力）     │
           │（用户、审计、通知、历史） │
           └────┬──────────────┘
                │
         ┌──────▼──────────────┐
         │      核心域（智能体工作流）     │
         │（模型、Prompt、Agent、RAG）│
         └─────────────────────┘
```

---

## ✅ 总结建议

| 内容    | 建议                               |
| ----- | -------------------------------- |
| 插件平台  | 可落在核心域（体现差异化能力），也可拆为独立 Plugin 子域 |
| MCP   | 建议作为核心域内“模型接入”的子模块，或插件协议适配器存在    |
| 定时任务  | 可保留在通用域，支持工作流异步调度                |
| 支付与计费 | 建议留在支撑域，结合调用统计做账单生成              |
| 国际化   | 明确属于通用域，不建议污染业务域逻辑               |
